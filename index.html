<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Monad × Binance Wallet 一键接入</title>
  <script src="https://unpkg.com/viem@2.x/dist/viem.js"></script>
  <script src="https://unpkg.com/@walletconnect/modal@2.x"></script>
  <script src="https://unpkg.com/@walletconnect/sign-client@2.x"></script>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; background: #000; color: #fff; text-align: center; padding: 40px; }
    button { margin: 10px; padding: 14px 28px; font-size: 16px; background: #f0b90b; color: #000; border: none; border-radius: 12px; cursor: pointer; }
    input, textarea { width: 90%; padding: 12px; margin: 10px; border-radius: 8px; border: none; }
    .container { max-width: 420px; margin: 0 auto; }
    .status { margin: 20px; padding: 15px; background: #1a1a1a; border-radius: 12px; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Monad × Binance Wallet</h1>
    <p>专为币安 Web3 钱包用户打造的一键入口</p>
    
    <div class="status" id="status">未连接</div>
    
    <button id="connectBtn">连接币安钱包</button>
    <button id="addMonadBtn" style="display:none">一键添加 Monad 主网</button>
    <button id="switchMonadBtn" style="display:none">切换到 Monad</button>
    
    <hr />
    <h3>发送 MON 转账（原生）</h3>
    <input type="text" id="toAddress" placeholder="接收地址 0x..." />
    <input type="text" id="amount" placeholder="数量（如 0.01）" />
    <button id="sendBtn" disabled>发送转账</button>
    
    <div class="status" id="txHash"></div>
  </div>

  <script type="module">
    const monadChain = {
      chainId: '0x520', // 1312 in hex
      chainName: 'Monad',
      nativeCurrency: { name: 'MON', symbol: 'MON', decimals: 18 },
      rpcUrls: ['https://rpc.monad.xyz'],
      blockExplorerUrls: ['https://explorer.monad.xyz'],
    };

    let account = null;
    let provider = null;

    // 检测是否在币安钱包浏览器环境
    const isBinanceWallet = () => {
      return navigator.userAgent.includes('Binance') || 
             (window.ethereum && window.ethereum.isBinance);
    };

    // 优先使用币安注入的 provider（深链）
    if (window.ethereum && (window.ethereum.isBinance || isBinanceWallet())) {
      provider = window.ethereum;
      console.log("检测到币安原生注入 provider");
    }

    const status = document.getElementById('status');
    const connectBtn = document.getElementById('connectBtn');
    const addMonadBtn = document.getElementById('addMonadBtn');
    const switchMonadBtn = document.getElementById('switchMonadBtn');
    const sendBtn = document.getElementById('sendBtn');

    async function connect() {
      if (!provider) {
        alert("请在币安 App 内打开，或使用支持 WalletConnect 的钱包");
        return;
      }

      try {
        const accounts = await provider.request({ method: 'eth_requestAccounts' });
        account = accounts[0];
        status.textContent = `已连接: ${account.slice(0,6)}...${account.slice(-4)}`;
        connectBtn.textContent = "已连接";
        connectBtn.disabled = true;
        addMonadBtn.style.display = "block";
        switchMonadBtn.style.display = "block";
        sendBtn.disabled = false;

        checkCurrentChain();
      } catch (err) {
        status.textContent = "连接拒绝或失败";
        console.error(err);
      }
    }

    async function checkCurrentChain() {
      try {
        const chainId = await provider.request({ method: 'eth_chainId' });
        if (chainId === '0x520') {
          status.textContent += ' (已在 Monad 主网)';
          addMonadBtn.style.display = "none";
        } else {
          addMonadBtn.style.display = "block";
        }
      } catch (e) {}
    }

    async function addAndSwitchMonad() {
      try {
        // 先尝试切换
        await provider.request({
          method: 'wallet_switchEthereumChain',
          params: [{ chainId: '0x520' }],
        });
      } catch (switchError) {
        if (switchError.code === 4902 || switchError.code === -32603) {
          // 未添加过，自动添加
          await provider.request({
            method: 'wallet_addEthereumChain',
            params: [monadChain],
          });
        }
      }
    }

    addMonadBtn.onclick = addAndSwitchMonad;
    switchMonadBtn.onclick = () => {
      provider.request({
        method: 'wallet_switchEthereumChain',
        params: [{ chainId: '0x520' }],
      });
    };

    sendBtn.onclick = async () => {
      const to = document.getElementById('toAddress').value.trim();
      const amount = document.getElementById('amount').value;

      if (!to || !amount || !account) return alert("请填写完整");

      try {
        const txHash = await provider.request({
          method: 'eth_sendTransaction',
          params: [{
            from: account,
            to: to,
            value: viem.parseEther(amount).toString(16),
          }],
        });

        document.getElementById('txHash').textContent = `交易已发送！Hash: ${txHash}`;
        document.getElementById('txHash').innerHTML += `<br><a href="https://explorer.monad.xyz/tx/${txHash}" target="_blank">查看交易</a>`;
      } catch (err) {
        alert("转账失败：" + (err.message || err));
      }
    };

    connectBtn.onclick = connect;

    // 自动尝试连接（币安钱包常见行为）
    if (provider && isBinanceWallet()) {
      setTimeout(connect, 800);
    }
  </script>
</body>
</html>