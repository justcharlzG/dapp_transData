<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Monad × 币安钱包 一键接入 (终极稳定版)</title>
  <style>
    body { margin:0; font-family:-apple-system,system-ui,sans-serif; background:#000; color:#fff; min-height:100vh; display:flex; align-items:center; justify-content:center; }
    .card { background:#111; border-radius:20px; padding:30px; width:90%; max-width:420px; box-shadow:0 20px 40px rgba(0,0,0,0.8); text-align:center; }
    h1 { margin:0 0 10px; font-size:24px; }
    button { width:100%; padding:16px; margin:12px 0; border:none; border-radius:12px; font-size:16px; font-weight:bold; cursor:pointer; }
    .connect { background:#f0b90b; color:#000; }
    .action { background:#333; color:#fff; }
    .action:disabled { opacity:0.5; }
    input { width:100%; padding:14px; margin:10px 0; border-radius:12px; border:none; background:#222; color:#fff; box-sizing:border-box; }
    .status { padding:15px; background:#1a1a1a; border-radius:12px; margin:15px 0; font-family:monospace; word-break:break-all; }
    a { color:#f0b90b; }
  </style>
</head>
<body>
  <div class="card">
    <h1>Monad 主网 (Chain ID 143)</h1>
    <p>专为币安 Web3 钱包用户打造</p>
    
    <div class="status" id="status">准备就绪</div>
    
    <button class="connect" id="connectBtn">连接钱包</button>
    <button class="action" id="switchBtn" style="display:none">一键切换到 Monad (143)</button>
    
    <hr style="border-color:#333;margin:20px 0">
    <h3>发送 MON</h3>
    <input type="text" id="to" placeholder="接收地址 0x...">
    <input type="text" id="amount" placeholder="数量（如 0.01）">
    <button class="action" id="sendBtn" disabled>发送转账</button>
    
    <div class="status" id="result"></div>
  </div>

  <!-- 固定版本，永不翻车 -->
  <script type="module">
    import { parseEther } from "https://cdn.jsdelivr.net/npm/viem@2.21.1/+esm";

    // Monad 主网配置（Chain ID 143）
    const MONAD = {
      chainId: 143,
      chainIdHex: "0x8f",
      chainName: "Monad",
      nativeCurrency: { name: "MON", symbol: "MON", decimals: 18 },
      rpcUrls: ["https://rpc.monad.xyz"],
      blockExplorerUrls: ["https://explorer.monad.xyz"]
    };

    let provider = null;
    let account = null;

    const status = document.getElementById("status");
    const connectBtn = document.getElementById("connectBtn");
    const switchBtn = document.getElementById("switchBtn");
    const sendBtn = document.getElementById("sendBtn");
    const result = document.getElementById("result");

    // 判断是否在币安钱包环境
    const isBinance = () => /Binance|BNB/i.test(navigator.userAgent) || window.ethereum?.isBinance;

    async function connect() {
      if (window.ethereum && isBinance()) {
        provider = window.ethereum;
      } else {
        alert("请在币安 App 内打开本页面，或使用支持 WalletConnect 的钱包扫码");
        return;
      }

      try {
        const accounts = await provider.request({ method: "eth_requestAccounts" });
        account = accounts[0];
        status.innerHTML = `已连接<br><small>${account}</small>`;
        connectBtn.textContent = "已连接";
        connectBtn.disabled = true;
        switchBtn.style.display = "block";
        sendBtn.disabled = false;
        checkChain();
      } catch (e) {
        status.textContent = "连接被拒绝";
        console.error(e);
      }
    }

    async function checkChain() {
      try {
        const chainId = await provider.request({ method: "eth_chainId" });
        if (parseInt(chainId, 16) === 143) {
          switchBtn.style.display = "none";
          status.innerHTML += "<br>已在 Monad 主网 ✅";
        }
      } catch {}
    }

    async function switchToMonad() {
      try {
        await provider.request({
          method: "wallet_switchEthereumChain",
          params: [{ chainId: MONAD.chainIdHex }],
        });
      } catch (switchError) {
        if (switchError.code === 4902 || switchError.message.includes("not found")) {
          try {
            await provider.request({
              method: "wallet_addEthereumChain",
              params: [MONAD],
            });
          } catch (addError) {
            alert("添加网络失败，币安暂不支持自动添加。请手动添加：\nChain ID: 143\nRPC: https://rpc.monad.xyz");
          }
        } else {
          alert("切换失败：" + (switchError.message || "Unsupported chain"));
        }
      }
      checkChain();
    }

    async function send() {
      const to = document.getElementById("to").value.trim();
      const amount = document.getElementById("amount").value;
      if (!to || !amount) return alert("请填写完整");

      try {
        const hash = await provider.request({
          method: "eth_sendTransaction",
          params: [{
            from: account,
            to: to,
            value: "0x" + parseEther(amount).toString(16),
          }],
        });
        result.innerHTML = `成功！<br><a href="https://explorer.monad.xyz/tx/${hash}" target="_blank">${hash}</a>`;
      } catch (e) {
        result.textContent = "失败：" + e.message;
      }
    }

    connectBtn.onclick = connect;
    switchBtn.onclick = switchToMonad;
    sendBtn.onclick = send;
  </script>
</body>
</html>