<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Monad ä¸€é”®è¿æ¥</title>

  <!-- WalletConnect v2 æ­£ç¡®å¼•ç”¨ -->
  <script src="https://unpkg.com/@walletconnect/modal@2.6.2/dist/index.umd.js"></script>
  <script src="https://unpkg.com/@walletconnect/sign-client@2.10.2/dist/index.umd.js"></script>
  <script src="https://unpkg.com/viem@1.19.11/index.js"></script>

  <style>
    body { 
      background: #000; 
      color: #fff; 
      font-family: -apple-system, BlinkMacSystemFont, sans-serif; 
      text-align: center; 
      padding: 30px; 
      max-width: 600px;
      margin: 0 auto;
    }
    
    button { 
      padding: 14px 28px; 
      margin: 10px; 
      background: #f0b90b; 
      color: #000; 
      border: none; 
      border-radius: 12px; 
      font-size: 16px; 
      cursor: pointer; 
      transition: all 0.3s;
    }
    
    button:hover { 
      background: #e6a800; 
    }
    
    button:disabled { 
      background: #666; 
      cursor: not-allowed; 
    }
    
    input { 
      width: 90%; 
      padding: 12px; 
      border-radius: 8px; 
      border: 1px solid #333; 
      margin: 10px 0; 
      background: #1a1a1a;
      color: #fff;
      font-size: 16px;
    }
    
    .status { 
      background: #1a1a1a; 
      padding: 15px; 
      border-radius: 12px; 
      margin-top: 20px; 
      border: 1px solid #333;
      word-break: break-all;
    }
    
    .error {
      background: #ff4444;
      color: #fff;
    }
    
    .success {
      background: #00aa00;
      color: #fff;
    }
    
    .loading {
      background: #f0b90b;
      color: #000;
    }
    
    a {
      color: #f0b90b;
      text-decoration: none;
    }
    
    a:hover {
      text-decoration: underline;
    }
  </style>
</head>
<body>

  <h1>ğŸ”— Monad WalletConnect</h1>
  <p>æ‰«ç è¿æ¥ä»»æ„ Web3 é’±åŒ…ï¼Œè‡ªåŠ¨æ·»åŠ  Monad ç½‘ç»œ</p>

  <button id="connectBtn">ğŸ“± æ‰«ç è¿æ¥é’±åŒ…</button>
  <button id="disconnectBtn" style="display:none; background:#ff4444; color:#fff;">æ–­å¼€è¿æ¥</button>

  <div class="status" id="status">ğŸ”´ æœªè¿æ¥</div>

  <hr style="margin:25px 0; opacity:0.2">

  <h3>ğŸ’¸ å‘é€ MONï¼ˆåŸç”Ÿä»£å¸ï¼‰</h3>
  <input id="toAddress" placeholder="æ¥æ”¶åœ°å€ 0x..." />
  <input id="amount" placeholder="æ•°é‡ï¼Œå¦‚ 0.01" />
  <button id="sendBtn" disabled>å‘é€ MON</button>
  <button id="addNetworkBtn" disabled style="background:#007bff;">æ·»åŠ  Monad ç½‘ç»œ</button>

  <div class="status" id="txHash"></div>
  <div class="status" id="errorMsg" style="display:none;"></div>


<script type="module">
  // ===========================
  // é…ç½®åŒºåŸŸ
  // ===========================
  // è·å–å…è´¹çš„ Project ID: https://cloud.walletconnect.com/
  const projectId = "512414a568dd1ac5074a89997f7870b7"; // è¿™æ˜¯ä¸€ä¸ªç¤ºä¾‹IDï¼Œè¯·æ›¿æ¢ä¸ºä½ è‡ªå·±çš„
  
  const monadChainId = 143; // Monad é“¾ ID
  const monadChainIdHex = "0x8f";
  const monadRpc = "https://rpc.monad.xyz";

  const monadChain = {
    chainId: monadChainIdHex,
    chainName: "Monad",
    rpcUrls: [monadRpc],
    nativeCurrency: { 
      name: "MON", 
      symbol: "MON", 
      decimals: 18 
    },
    blockExplorerUrls: ["https://explorer.monad.xyz"],
  };

  // ===========================
  // å…¨å±€å˜é‡
  // ===========================
  let signClient = null;
  let wcModal = null;
  let session = null;
  let account = null;

  const status = document.getElementById("status");
  const connectBtn = document.getElementById("connectBtn");
  const disconnectBtn = document.getElementById("disconnectBtn");
  const sendBtn = document.getElementById("sendBtn");
  const addNetworkBtn = document.getElementById("addNetworkBtn");
  const errorMsg = document.getElementById("errorMsg");

  // ===========================
  // å·¥å…·å‡½æ•°
  // ===========================
  function showStatus(message, type = 'normal') {
    status.className = `status ${type}`;
    status.innerHTML = message;
  }

  function showError(message) {
    errorMsg.style.display = 'block';
    errorMsg.className = 'status error';
    errorMsg.innerHTML = `âŒ ${message}`;
    setTimeout(() => {
      errorMsg.style.display = 'none';
    }, 5000);
  }

  function isValidAddress(address) {
    return /^0x[a-fA-F0-9]{40}$/.test(address);
  }

  // ===========================
  // åˆå§‹åŒ– WalletConnect
  // ===========================
  async function initWC() {
    try {
      showStatus("ğŸ”„ åˆå§‹åŒ– WalletConnect...", "loading");
      
      signClient = await window.WalletConnect.SignClient.init({
        projectId,
        metadata: {
          name: "Monad Connect",
          description: "è¿æ¥åˆ° Monad ç½‘ç»œè¿›è¡Œ MON ä»£å¸è½¬è´¦",
          url: window.location.origin,
          icons: ["https://avatars.githubusercontent.com/u/37784886"],
        },
      });

      wcModal = new window.WalletConnect.WalletConnectModal({
        projectId,
        chains: [`eip155:${monadChainId}`],
      });

      // æ£€æŸ¥ç°æœ‰ä¼šè¯
      if (signClient.session.length) {
        const lastSession = signClient.session[signClient.session.length - 1];
        onSessionConnected(lastSession);
      }

      showStatus("ğŸ”´ æœªè¿æ¥");
    } catch (error) {
      console.error('åˆå§‹åŒ–å¤±è´¥:', error);
      showError(`åˆå§‹åŒ–å¤±è´¥: ${error.message}`);
    }
  }

  // ===========================
  // è¿æ¥å¤„ç†
  // ===========================
  function onSessionConnected(sessionData) {
    session = sessionData;
    const accounts = session.namespaces?.eip155?.accounts || [];
    
    if (accounts.length > 0) {
      account = accounts[0].split(":")[2];
      showStatus(`ğŸŸ¢ å·²è¿æ¥: ${account.slice(0, 6)}...${account.slice(-4)}`, "success");
      
      connectBtn.style.display = 'none';
      disconnectBtn.style.display = 'inline-block';
      sendBtn.disabled = false;
      addNetworkBtn.disabled = false;
    }
  }

  // ===========================
  // å‘èµ·æ‰«ç è¿æ¥
  // ===========================
  async function connectWallet() {
    try {
      if (!signClient) await initWC();

      showStatus("ğŸ”„ æ­£åœ¨è¿æ¥...", "loading");

      const { uri, approval } = await signClient.connect({
        requiredNamespaces: {
          eip155: {
            chains: [`eip155:${monadChainId}`],
            methods: [
              "eth_sendTransaction",
              "eth_accounts",
              "eth_requestAccounts",
              "personal_sign",
              "eth_signTypedData",
              "wallet_addEthereumChain",
              "wallet_switchEthereumChain"
            ],
            events: ["accountsChanged", "chainChanged"],
          },
        },
      });

      // æ˜¾ç¤ºäºŒç»´ç 
      if (uri) {
        wcModal.openModal({ uri });
        showStatus("ğŸ“± è¯·åœ¨é’±åŒ…ä¸­æ‰«æäºŒç»´ç ", "loading");
      }

      const sessionData = await approval();
      wcModal.closeModal();
      
      onSessionConnected(sessionData);
      
    } catch (error) {
      console.error('è¿æ¥å¤±è´¥:', error);
      showError(`è¿æ¥å¤±è´¥: ${error.message}`);
      wcModal?.closeModal();
    }
  }

  // ===========================
  // æ–­å¼€è¿æ¥
  // ===========================
  async function disconnectWallet() {
    try {
      if (session) {
        await signClient.disconnect({
          topic: session.topic,
          reason: {
            code: 6000,
            message: "ç”¨æˆ·æ–­å¼€è¿æ¥"
          }
        });
      }
      
      session = null;
      account = null;
      
      showStatus("ğŸ”´ æœªè¿æ¥");
      connectBtn.style.display = 'inline-block';
      disconnectBtn.style.display = 'none';
      sendBtn.disabled = true;
      addNetworkBtn.disabled = true;
      
    } catch (error) {
      console.error('æ–­å¼€è¿æ¥å¤±è´¥:', error);
      showError(`æ–­å¼€è¿æ¥å¤±è´¥: ${error.message}`);
    }
  }

  // ===========================
  // æ·»åŠ  Monad ç½‘ç»œ
  // ===========================
  async function addMonadNetwork() {
    try {
      if (!session) {
        showError("è¯·å…ˆè¿æ¥é’±åŒ…");
        return;
      }

      showStatus("ğŸ”„ æ­£åœ¨æ·»åŠ  Monad ç½‘ç»œ...", "loading");

      const result = await signClient.request({
        topic: session.topic,
        chainId: `eip155:${monadChainId}`,
        request: {
          method: "wallet_addEthereumChain",
          params: [monadChain],
        },
      });

      showStatus("âœ… Monad ç½‘ç»œæ·»åŠ æˆåŠŸ", "success");
      
    } catch (error) {
      console.error('æ·»åŠ ç½‘ç»œå¤±è´¥:', error);
      if (error.message.includes("already exists")) {
        showStatus("â„¹ï¸ Monad ç½‘ç»œå·²å­˜åœ¨", "success");
      } else {
        showError(`æ·»åŠ ç½‘ç»œå¤±è´¥: ${error.message}`);
      }
    }
  }

  // ===========================
  // å‘é€ MON è½¬è´¦
  // ===========================
  async function sendTransaction() {
    try {
      const to = document.getElementById("toAddress").value.trim();
      const amount = document.getElementById("amount").value.trim();

      // è¾“å…¥éªŒè¯
      if (!to) {
        showError("è¯·è¾“å…¥æ¥æ”¶åœ°å€");
        return;
      }

      if (!isValidAddress(to)) {
        showError("æ¥æ”¶åœ°å€æ ¼å¼ä¸æ­£ç¡®");
        return;
      }

      if (!amount || isNaN(amount) || Number(amount) <= 0) {
        showError("è¯·è¾“å…¥æ­£ç¡®çš„è½¬è´¦é‡‘é¢");
        return;
      }

      if (!session || !account) {
        showError("è¯·å…ˆè¿æ¥é’±åŒ…");
        return;
      }

      showStatus("ğŸ”„ æ­£åœ¨å‘é€äº¤æ˜“...", "loading");

      // å°†é‡‘é¢è½¬æ¢ä¸º wei
      const amountWei = BigInt(Number(amount) * Math.pow(10, 18));
      const valueHex = "0x" + amountWei.toString(16);

      const transaction = {
        from: account,
        to: to,
        value: valueHex,
        data: "0x",
      };

      const txHash = await signClient.request({
        topic: session.topic,
        chainId: `eip155:${monadChainId}`,
        request: {
          method: "eth_sendTransaction",
          params: [transaction],
        },
      });

      showStatus("ğŸŸ¢ å·²è¿æ¥", "success");
      
      document.getElementById("txHash").innerHTML = `
        <div style="color: #00aa00;">
          âœ… äº¤æ˜“å‘é€æˆåŠŸï¼<br><br>
          <strong>äº¤æ˜“å“ˆå¸Œ:</strong><br>
          ${txHash}<br><br>
          <a href="https://explorer.monad.xyz/tx/${txHash}" target="_blank">
            ğŸ” åœ¨åŒºå—é“¾æµè§ˆå™¨ä¸­æŸ¥çœ‹
          </a>
        </div>
      `;

      // æ¸…ç©ºè¾“å…¥æ¡†
      document.getElementById("toAddress").value = "";
      document.getElementById("amount").value = "";

    } catch (error) {
      console.error('å‘é€äº¤æ˜“å¤±è´¥:', error);
      showError(`å‘é€äº¤æ˜“å¤±è´¥: ${error.message}`);
    }
  }

  // ===========================
  // äº‹ä»¶ç›‘å¬
  // ===========================
  connectBtn.onclick = connectWallet;
  disconnectBtn.onclick = disconnectWallet;
  sendBtn.onclick = sendTransaction;
  addNetworkBtn.onclick = addMonadNetwork;

  // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
  window.addEventListener('load', initWC);

</script>

</body>
</html>